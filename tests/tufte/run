#!/usr/bin/env bash
cd "$(dirname "$BASH_SOURCE[0]")" || exit 1



/bin/rm -rf test-tufte
mkdir -p test-tufte

cd test-tufte
if [ "${USE_REMOTE_TUFTE:-0}" = 1 ] ; then
    curl -L https://github.com/Tufte-LaTeX/tufte-latex/tarball/master | tar zxv --strip=1
else
    # Use the checked-in snapshot for reproducibility
    cp -R ../tufte/test-tufte/* .
fi

/bin/rm -rf bin
mkdir -p bin
cp ../../../bin/latex-docker* bin

/bin/rm -rf dockers
mkdir -p dockers/latex-base
cp ../../../dockers/latex-base/* dockers/latex-base

/bin/rm -rf dockers/latex
bin/latex-docker-setup-base
sed -i "" -e 's/^RUN tlmgr/RUN echo skip tlmgr/' dockers/latex/Dockerfile

bin/latex-docker-setup

/bin/rm -rf graphics/sine.pdf
bin/asy -f pdf -o graphics/sine.pdf graphics/sine.asy || exit 1

chmod u+w sample-handout.pdf 2>/dev/null || true
/bin/rm -rf sample-handout.pdf

bin/pdflatex -interaction=nonstopmode -halt-on-error sample-handout || exit 1
bin/bibtex   sample-handout || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-handout || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-handout || exit 1

chmod u+w sample-book.pdf 2>/dev/null || true
/bin/rm -rf sample-book.pdf

bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1
bin/bibtex sample-book || exit 1
bin/xindy --language english sample-book.idx || exit 1
bin/makeindex sample-book.idx || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1

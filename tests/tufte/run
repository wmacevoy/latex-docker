#!/usr/bin/env bash

cd "$(dirname "$BASH_SOURCE[0]")" || exit 1

reset=false

while [ $# -gt 0 ] ; do
    case "$1" in
        --reset)
            reset=true
            shift
            ;;
        *)
            echo unknown argument: "$1"
            exit 1
            ;;
    esac
done

if [ $reset = true ] ; then
    /bin/rm -rf test-tufte
fi

mkdir -p test-tufte
cd test-tufte
if [ ! -f sample-book.tex ] ; then
    curl -L https://github.com/Tufte-LaTeX/tufte-latex/tarball/master | tar zxv --strip=1
fi

/bin/rm -rf bin
mkdir -p bin
cp ../../../bin/latex-docker* bin

/bin/rm -rf dockers
mkdir -p dockers/latex-base
cp ../../../dockers/latex-base/* dockers/latex-base

/bin/rm -rf dockers/latex
bin/latex-docker-setup-base
# Flip FULL -> skip
sed -i.bak \
  -e 's/^[[:space:]]*\(RUN echo full texlive install\) run \&\&/\1 skip ||/' \
  dockers/latex/Dockerfile

# Flip TUFTE -> run
sed -i.bak \
  -e 's/^[[:space:]]*\(RUN echo tufte latex install\) skip ||/\1 run \&\&/' \
  dockers/latex/Dockerfile
  
bin/latex-docker-setup

/bin/rm -rf graphics/sine.pdf
bin/asy -f pdf -o graphics/sine.pdf graphics/sine.asy || exit 1

chmod u+w sample-handout.pdf 2>/dev/null || true
/bin/rm -rf sample-handout.pdf

bin/pdflatex -interaction=nonstopmode -halt-on-error sample-handout || exit 1
bin/bibtex   sample-handout || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-handout || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-handout || exit 1

chmod u+w sample-book.pdf 2>/dev/null || true
/bin/rm -rf sample-book.pdf

bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1
bin/bibtex sample-book || exit 1
bin/xindy --language english sample-book.idx || exit 1
bin/makeindex sample-book.idx || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1
bin/pdflatex -interaction=nonstopmode -halt-on-error sample-book || exit 1

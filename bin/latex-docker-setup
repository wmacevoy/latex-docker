#!/bin/bash

get_script_dir () {
    pushd $(dirname "${BASH_SOURCE[0]}") >/dev/null
    pwd
    popd >/dev/null
}

THIS_DIR="$(get_script_dir)"
BASE_DIR="$(dirname "$THIS_DIR")"
BASE_NAME="$(basename "$BASE_DIR")"
base_name="$(echo $BASE_NAME | tr ' [:upper:]' '_[:lower:]')"


"$THIS_DIR"/latex-docker-setup-base

(cd "$BASE_DIR/dockers" && docker build -t "$base_name/latex:latest" latex)

# Collect commands from all PATH directories inside the container to expose them via host-side wrappers
CMDS="$(docker run --rm -a stdin -a stdout "$base_name/latex:latest" /bin/sh -lc 'IFS=:; for d in $PATH; do [ -d "$d" ] && ls -1 "$d"; done | sort -u')"

cd "$BASE_DIR/bin"
if [ ! -f .gitignore ] ; then touch .gitignore ; fi
for cmd in $CMDS
do
    /bin/rm -rf "$cmd"
    ln -s "latex-docker-command" "$cmd"
    chmod +x "$BASE_DIR/bin/$cmd"
    if ! grep -Fxq "$cmd" .gitignore
    then
        echo "$cmd" >> .gitignore
    fi
done

echo 'Type ". bin/latex-docker-context" to add $BASE_DIR/bin to your PATH.'
echo 'Type ". bin/latex-docker-uncontext" to remove it.'


